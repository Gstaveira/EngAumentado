<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <title>Dashboard - Monitoramento de Plaquetas</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f5f6fa;
        }
        .card {
            border-radius: 12px;
        }
        .header-title {
            margin-top: 20px;
            font-weight: 700;
        }
        .badge-alert {
            font-size: 1rem;
            padding: 8px 12px;
            border-radius: 8px;
        }
    </style>
</head>

<body>

<div class="container my-4">

    <h1 class="header-title">ðŸ“ˆ Dashboard â€“ Monitoramento de Plaquetas</h1>
    <p class="text-muted">Acompanhamento epidemiolÃ³gico baseado em hemogramas</p>

    <!-- Linha superior -->
    <div class="row mt-4">

        <!-- Card de alertas -->
        <div class="col-md-4">
            <div class="card shadow-sm p-3">
                <h5 class="card-title">Alertas (Ãºltimos 30 dias)</h5>
                <h2 class="text-danger fw-bold">{{ alert_count }}</h2>
                <a href="/run_detection" class="btn btn-danger w-100 mt-2">ðŸš¨ Rodar DetecÃ§Ã£o</a>
            </div>
        </div>

        <!-- Upload -->
        <div class="col-md-4">
            <div class="card shadow-sm p-3">
                <h5 class="card-title">Importar Dados</h5>
                <p class="text-muted">FaÃ§a upload de um arquivo CSV com hemogramas.</p>
                <a href="/upload" class="btn btn-primary w-100">ðŸ“¤ Enviar CSV</a>
            </div>
        </div>

        <!-- Lista de municÃ­pios -->
        <div class="col-md-4">
            <div class="card shadow-sm p-3">
                <h5 class="card-title">MunicÃ­pios</h5>
                <ul class="list-group">
                    {% for m in municipios %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ m }}
                        <a class="btn btn-sm btn-outline-primary" href="/plot/{{ m }}">ðŸ“Š Ver grÃ¡fico</a>
                    </li>
                    {% else %}
                    <li class="list-group-item text-muted">Nenhum municÃ­pio cadastrado</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

    </div>

    <!-- Alertas recentes -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm p-4">
                <h4 class="card-title mb-3">ðŸ“œ Alertas Recentes</h4>
                <div id="alerts" class="mt-3">Carregando...</div>
            </div>
        </div>
    </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Script para carregar alertas -->
<script>
fetch('/api/alerts')
  .then(r => r.json())
  .then(data => {
    const div = document.getElementById("alerts");

    if (!data || data.length === 0) {
        div.innerHTML = "<p class='text-muted'>Nenhum alerta encontrado.</p>";
        return;
    }

    let html = `
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>MunicÃ­pio</th>
                    <th>Tipo</th>
                    <th>DescriÃ§Ã£o</th>
                </tr>
            </thead>
            <tbody>
    `;

    data.forEach(a => {
        html += `
            <tr>
                <td>${a.date}</td>
                <td>${a.municipio}</td>
                <td><span class='badge bg-danger'>${a.tipo}</span></td>
                <td>${a.descricao}</td>
            </tr>`;
    });

    html += "</tbody></table>";
    div.innerHTML = html;

  })
  .catch(() => {
    document.getElementById("alerts").innerHTML =
      "<p class='text-danger'>Erro ao carregar alertas.</p>";
  });
</script>

</body>
</html>
